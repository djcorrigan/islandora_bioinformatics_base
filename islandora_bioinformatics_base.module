<?php

/**
  * @file
  * Hooks and callbacks for the module.
  */

// Permissions.
define('ISLANDORA_VIEW_OBJECTS', 'view fedora repository objects');
define('ISLANDORA_METADATA_EDIT', 'edit fedora metadata');
define('ISLANDORA_ADD_DS', 'add fedora datastreams');
define('ISLANDORA_INGEST', 'ingest fedora objects');
define('ISLANDORA_PURGE', 'delete fedora objects and datastreams');
define('ISLANDORA_MANAGE_PROPERTIES', 'manage object properties');
define('ISLANDORA_VIEW_DATASTREAM_HISTORY', 'view old datastream versions');
define('ISLANDORA_MANAGE_DELETED_OBJECTS', 'manage deleted objects');
define('ISLANDORA_REVERT_DATASTREAM', 'revert to old datastream');
define('ISLANDORA_REGENERATE_DERIVATIVES', 'regenerate derivatives for an object');

/**
 * Implements hook_menu().
 *
 * @author Natasha Squires
 * @author Nolan Phillips <ncphillups@upei.ca>
 */
function islandora_bioinformatics_base_menu() {
  return array(
    'islandora/object/%islandora_object/lab_objects/' => array(
      /*
       * Lists all lab_objects associated with the %islandora_object.
       * @TODO
       */
    ),

    'islandora/object/%islandora_object/ingest/%rel_cmodel' => array(
      /*
       * Begins the ingestion process for a new object that will
       * be of a type %cmodel and related to %islandora_object.
       * @TODO
       */
    ),

    'islandora/object/%islandora_object/people' => array(
      /**
       * Creates a tab alongside the Manage and View tabs. This links to a page
       * listing all of the people in the project.
       */

      'title' => 'People',
      'type' => MENU_LOCAL_TASK,
      'description' => 'People collaborating on this project.',
      'page callback' => 'rel_people_list', //TODO: Write this callback.
      'page arguments' => array(2),
      'access callback' => 'islandora_object_access_callback',
      'access arguments' => array(ISLANDORA_VIEW_OBJECTS, 2),
      'file' => 'includes/manage_project.inc',
    ),

    'islandora/object/%islandora_object/people/add' => array(
      /**
       * Displays form for adding/removing people to %islandora_object.
       */
      'title callback' => 'add_person_title',
      'title arguments' => array(3),
      'description' => 'Adds a person to a project',
      'page callback' => 'drupal_get_form',
      'type' => MENU_CALLBACK,
      'page arguments' => array('islandora_bioinformatics_base_assign_person_to_project_form'),
      'access callback' => 'islandora_bioinformatics_base_access',
      'access arguments' => array(2),
      'file' => 'includes/islandora_bioinformatics_base_assign_person_to_project.form.inc',
    ),
  );
}

/**
 * cmodel_load
 *
 * This function assumes that Content Model IDs follow
 * the pattern "islandora:" . $name . "_cmodel"
 *
 * @author Nolan Phillips <ncphillips@upei.ca>
 * @param String $cmodel_id_part
 * This is a partial ID of an Islandora Content Model.
 * @return FedoraObject $object | null
 * If a FedoraObject is found and it is a Content Model, return it;
 * else, return NULL.
 */
function cmodel_load($cmodel_id_part) {
  $cmodel_id = "islandora:" . $cmodel_id_part . "_cmodel";
  $cmodel = islandora_object_load($cmodel_id);
  if ($cmodel && !in_array('fedora-system:ContentModel-3.0', $cmodel->models)) {
    return NULL;
  }
  return $cmodel;
}

/**
 * rel_cmodel_load
 *
 * @author Nolan Phillips ncphillips@upei.ca
 * @param string $cmodel_id_part
 * @param IslandoraFedoraObject $object
 * @return FedoraObject|null
 * If the cmodel exists and has a datarel_partOf relationship to
 * the cmodel of %object, then it is returned; else return NULL.
 */
function rel_cmodel_load($cmodel_id_part, $object) {
  $cmodel = cmodel_load($cmodel_id_part);
  // If a cmodel FedoraObject is found.
  if ($object) {
    $pred_uri = ""; // There is currently no pred_uri
    $pred = "datarel";
    $target_id = $object->id;
    $type = FALSE; // Don't know why.

    // Check if it has a datarel to the target object.
    if (!islandora_object_has_relationship($cmodel, $pred_uri, $pred, $target_id, $type))
      return NULL;
  }
  return $cmodel;
}


function rel_lab_objects_list($object) {
  /** @TODO
    Invokes hook_rel_lab_object_list
    Invokes drupal_alter on
      hook_rel_lab_object_list_alter
      get list of all related cmodels, and remove the non lab_object subtypes
        for each related cmodel, where the cmodel name is TYPE
          hook_rel_lab_object_TYPE_list_alter
    See the bottom of the following function for an example of how to do this alter
    calling https://api.drupal.org/api/drupal/includes%21form.inc/function/drupal_prepare_form/7
   */

}

/**
 * Implements hook_rel_lab_objects_list.
 */
function islandora_bioinformatics_base_rel_lab_objects_list($object) {
  /** @TODO */
  }


function rel_people_list($object) {
  /** @TODO
    invoke hook_rel_people_list
    invoke drupal_alter on hook_rel_people_list_alter
   */
   module_load_include("inc", "islandora_bioinformatics_base", "manage_project");
   $project_people_function = "islandora_project_people";
   return $project_people_function($object);
   
}

/**
 * Implements hook_rel_people_list.
 */
function islandora_bioinformatics_base_rel_people_list($object) {

}

function rel_lab_object_ingest($object, $cmodel) {

}

/**
  * Implements hook_theme().
  */
function islandora_bioinformatics_base_theme($existing, $type, $theme, $path) {
  return array(
    'islandora_person' => array(
      'file' => 'theme/theme.inc',
      'template' => 'theme/islandora_person',
      'pattern' => 'islandora_person__',
      'variables' => array(
        'object' => NULL,
      ),
    ),
    'islandora_project' => array(
      'file' => 'theme/theme.inc',
      'template' => 'theme/islandora_project',
      'pattern' => 'islandora_project__',
      'variables' => array(
        'object' => NULL,
      ),
    ),
  );
}

/**
  * Implements hook_CMODEL_PID_islandora_view_object() for Person.
  */
function islandora_bioinformatics_base_person_cmodel_islandora_view_object(AbstractObject $person) {
  $output = theme('islandora_bioinformatics_base', array('object' => $person));
  return array(
    'islandora_person' => $output,
  );
}

/**
  * Implements hook_CMODEL_PID_islandora_view_object() for Project.
  */
function islandora_bioinformatics_base_project_cmodel_islandora_view_object(AbstractObject $project) {
  $output = theme('islandora_bioinformatics_base', array('object' => $project));
  return array(
    'islandora_project' => $output,
  );
}

/**
  * Implements hook_islandora_required_objects().
  */

function islandora_bioinformatics_base_islandora_required_objects(IslandoraTuque $connection) {
  /*
   * @TODO Add datarel from Person to Project.
   * @TODO Add datarel from Lab Object to Project.
   */

  $module_path = drupal_get_path('module', 'islandora_bioinformatics_base');

  //---------Project Content Model------------------------------------------------------------------------------------//
  $project_cm = $connection->repository->constructObject('islandora:project_cmodel');
  $project_cm->owner = 'fedoraAdmin';
  $project_cm->label = 'Project Content Model';
  $project_cm->models = 'fedora-system:ContentModel-3.0';

  $datastream = $project_cm->constructDatastream('DS-COMPOSITE-MODEL', 'X');
  $datastream->label = 'Project Datastreams';
  $datastream->mimetype= 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/content_models/Project_ds_composite_model.xml", FALSE);
  $project_cm->ingestDatastream($datastream);

  //---------Project Content Model------------------------------------------------------------------------------------//
  $person_cm = $connection->repository->constructObject('islandora:person_cmodel');
  $person_cm->owner = 'fedoraAdmin';
  $person_cm->label = 'Person Content Model';
  $person_cm->models = 'fedora-system:ContentModel-3.0';

  $datastream = $person_cm->constructDatastream('DS-COMPOSITE-MODEL', 'X');
  $datastream->label = 'Person Datastreams';
  $datastream->mimetype= 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/content_models/Person_ds_composite_model.xml", FALSE);
  $person_cm->ingestDatastream($datastream);

  // Create relationship with LabObject
  $person_cm->relationships->add('', 'datarel_partOf', 'islandora:project_cmodel');

  //---------Lab Object Content Model---------------------------------------------------------------------------------//
  $lab_object_cm = $connection->repository->constructObject('islandora:lab_object_cmodel');
  $lab_object_cm->owner = 'fedoraAdmin';
  $lab_object_cm->label = 'LabObject Abstract Content Model';
  $lab_object_cm->models = 'fedora-system:ContentModel-3.0';

  $datastream = $lab_object_cm->constructDatastream('DS-COMPOSITE-MODEL', 'X');
  $datastream->label = 'LabObject content model';
  $datastream->mimetype= 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/content_models/LabObject_ds_composite_model.xml", FALSE);
  $lab_object_cm->ingestDatastream($datastream);

  //---------Lab Activity Content Model-------------------------------------------------------------------------------//
  $lab_activity_cm = $connection->repository->constructObject('islandora:lab_activity_cmodel');
  $lab_activity_cm->owner = 'fedoraAdmin';
  $lab_activity_cm->label = 'LabActivity Abstract Content Model';
  $lab_activity_cm->models = 'fedora-system:ContentModel-3.0';

  $datastream = $lab_activity_cm->constructDatastream('DS-COMPOSITE-MODEL', 'X');
  $datastream->label = 'LabActivity content model';
  $datastream->mimetype= 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/content_models/LabActivity_ds_composite_model.xml", FALSE);
  $lab_activity_cm->ingestDatastream($datastream);

  //---------Project Collection---------------------------------------------------------------------------------------//
  $project_collection = $connection->repository->constructObject('islandora:project_collection');
  $project_collection->owner = 'fedoraAdmin';
  $project_collection->label = 'Project Collection';
  $project_collection->models = 'islandora:collectionCModel';
  $project_collection->relationships->add(FEDORA_RELS_EXT_URI, 'isMemberOfCollection', 'islandora:root');
  $datastream = $project_collection->constructDatastream('COLLECTION_POLICY', 'X');
  $datastream->mimetype = 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/collections/islandora_bioinformatics_project_collection_policy.xml", FALSE);
  $project_collection->ingestDatastream($datastream);

  //---------Person Collection ---------------------------------------------------------------------------------------//
  $person_collection = $connection->repository->constructObject('islandora:person_collection');
  $person_collection->owner = 'fedoraAdmin';
  $person_collection->label = 'Person Collection';
  $person_collection->models = 'islandora:collectionCModel';
  $person_collection->relationships->add(FEDORA_RELS_EXT_URI, 'isMemberOfCollection', 'islandora:root');
  $datastream = $person_collection->constructDatastream('COLLECTION_POLICY', 'X');
  $datastream->mimetype = 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/collections/islandora_bioinformatics_person_collection_policy.xml", FALSE);
  $person_collection->ingestDatastream($datastream);


  return array(
    'islandora_bioinformatics_base' => array(
      'title' => 'Bioinformatics Base',
      'objects' => array(
        $project_cm,
        $project_collection,
        $person_cm,
        $person_collection,
        $lab_object_cm,
        $lab_activity_cm,
      ),
    ),
  );
}

function islandora_bioinformatics_base_islandora_xml_form_builder_forms() {
  $module_path = drupal_get_path('module', 'islandora_bioinformatics_base');
  return array(
    'Person' => array(
      'form_file' => "$module_path/xml/forms/islandora_bioinformatics_person_form_mads.xml",
    ),
    'Project' => array(
      'form_file' => "$module_path/xml/forms/islandora_bioinformatics_project_form_mads.xml",
    ),
  );
}

function islandora_bioinformatics_base_islandora_xml_form_builder_form_associations() {
  return array(
    'islandora_bioinformatics_person_form_mads' => array(
      'content_model' => 'islandora:person_cmodel',
      'form_name' => 'Person',
      'dsid' => 'MADS',
      'title_field' => array('authority', 'titleInfo', 'title'),
      'transform' => '',
      'template' => FALSE,
    ),
    'islandora_bioinformatics_project_mads_form' => array(
      'content_model' => 'islandora:project_cmodel',
      'form_name' => 'Project',
      'dsid' => 'MADS',
      'transform' => '',
      'title_field' => array('authority', 'titleInfo', 'title'),
      'template' => FALSE,
    ),
  );
}
  
 /**
 * Implements hook_islandora_ingest_steps() for the person_cmodel.
 */
function islandora_bioinformatics_base_islandora_person_cmodel_islandora_ingest_steps(array $configuration) {

  return array(
    'islandora_bioinformatics_base' => array(
      'weight' => 10,
      'type' => 'form',
      'form_id' => 'islandora_bioinformatics_base_image_upload_form',
      'module' => 'islandora_bioinformatics_base',
      'file' => 'includes/islandora_bioinformatics_base_image_upload.form.inc',
    ),
  );
}

 /**
 * Implements hook_islandora_ingest_steps() for the project_cmodel.
 */
function islandora_bioinformatics_base_islandora_project_cmodel_islandora_ingest_steps(array $configuration) {
  return array(
    'islandora_bioinformatics_base' => array(
      'weight' => 10,
      'type' => 'form',
      'form_id' => 'islandora_bioinformatics_base_image_upload_form',
      'module' => 'islandora_bioinformatics_base',
      'file' => 'includes/islandora_bioinformatics_base_image_upload.form.inc',
    ),
  /*
   *	islandora_bioinformatics_base_assign_person_to_project_form has to be the last ingest step called.  If not, then people can exit the ingest process 	after submitting the form and creating relationships within person objects.
  */
  'islandora_bioinformatics_base_person_project' => array(
    'weight' => 15,
    'type' => 'form',
    'form_id' => 'islandora_bioinformatics_base_assign_person_to_project_form',
    'module' => 'islandora_bioinformatics_base',
    'file' => 'includes/islandora_bioinformatics_base_assign_person_to_project.form.inc',
  ),
  );
}
